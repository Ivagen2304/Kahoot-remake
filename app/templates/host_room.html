{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Лоббі хоста - Kahoot-remake</title>
    <link rel="icon" type="image/ico+xml" href="https://assets-cdn.kahoot.it/controller/v2/favicon.ico" />
    <style>
        body {
            margin: 0;
            height: 100vh;
            background-image: url("{% static 'Home_bg.png' %}");
            background-size: cover;
            background-position: center;
            font-family: 'Nunito', Arial, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .lobby-container {
            background-color: rgba(0, 0, 0, 0.514);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
        }

        .lobby-container::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #8a2be2, #764ba2, #ffffff71, #764ba2, #8a2be2);
            border-radius: 25px;
            z-index: -1;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #8a2be2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-code {
            font-size: 36px;
            font-weight: bold;
            color: #ff69b4;
            margin-bottom: 30px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            border-radius: 15px;
            display: inline-block;
            letter-spacing: 5px;
        }

        .players-section {
            margin-bottom: 30px;
        }

        .players-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #8a2be2;
        }

        #players {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        #players.waiting {
            max-height: none;
            overflow-y: visible;
        }

        #players li {
            background-color: rgba(138, 43, 226, 0.1);
            margin: 5px 0;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 18px;
            transition: background-color 0.3s;
        }

        #players li:hover {
            background-color: rgba(138, 43, 226, 0.2);
        }

        #players li.pulse {
            background-color: transparent;
            padding: 0;
            margin: 0;
            color: #ff69b4;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .start-btn {
            background: linear-gradient(45deg, #8a2be2, #ff69b4);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #question {
            margin-top: 30px;
            font-size: 24px;
            color: #8a2be2;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="lobby-container">
        <h1>Лоббі хоста</h1>
        <div class="game-code">{{ session.code }}</div>

        <div class="players-section">
            <div class="players-title" id="playersTitle">Гравці:</div>
            <ul id="players">
                {% for player in session.players.all %}
                    <li>{{ player.name }}</li>
                {% empty %}
                    <li class="pulse">Очікуємо гравців...</li>
                {% endfor %}
            </ul>
        </div>

        {% if request.user == session.host %}
            <button type="button" class="start-btn" onclick="onStartClick()" id="startBtn">Почати гру</button>
        {% endif %}

        <div id="question"></div>
    </div>

<script>
window.addEventListener("load", () => {
    const code = "{{ session.code }}";  // Переконайся, що це не порожнє
    const playerName = "{{ request.user.username|default:'Host' }}";
    const isHost = {% if request.user == session.host %}true{% else %}false{% endif %};
    const startBtn = document.getElementById("startBtn"); // твоя кнопка
    const nameInput = document.getElementById("nameInput"); // поле для імені
    const playersList = document.getElementById("players"); // ul для гравців
    const questionBox = document.getElementById("question"); // div або p для питання

    let playersInLobby = [];

    // Створюємо WebSocket
    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/game/" + code + "/?name=" + encodeURIComponent(playerName)
    );


    // Коли підключення відкрите
    socket.onopen = () => {
        console.log("WebSocket connected");
        if(startBtn) startBtn.disabled = false; // Кнопка активна тільки після підключення
    };

    // Обробка повідомлень від сервера
    socket.onmessage = function (event) {
    console.log("RAW MESSAGE:", event.data);

    const data = JSON.parse(event.data);
    console.log("PARSED:", data);

    if (data.type === "players") {
        playersInLobby = data.players; // ← ОЦЕ ГОЛОВНЕ
        console.log("Players in lobby:", playersInLobby.length);
    }

        if(data.type === "players" && playersList) {
            playersList.innerHTML = "";
            const playersTitle = document.getElementById("playersTitle");
            if (data.players.length === 0) {
                playersList.classList.add("waiting");
                const li = document.createElement("li");
                li.textContent = "Очікуємо гравців...";
                li.className = "pulse";
                playersList.appendChild(li);
                if (playersTitle) playersTitle.style.display = "none";
            } else {
                playersList.classList.remove("waiting");
                data.players.forEach(name => {
                    const li = document.createElement("li");
                    li.textContent = name;
                    if (isHost) {
                        const btn = document.createElement("button");
                        btn.textContent = "X";
                        btn.style.background = "red";
                        btn.style.color = "white";
                        btn.style.border = "none";
                        btn.style.padding = "2px 5px";
                        btn.style.cursor = "pointer";
                        btn.style.float = "right";
                        btn.onclick = () => kickPlayer(name);
                        li.appendChild(btn);
                    }
                    playersList.appendChild(li);
                });
                if (playersTitle) playersTitle.style.display = "block";
            }
        }


        if(data.type === "game_started") {
            console.log("GAME STARTED");
            // Тут можна робити редірект або показати питання
        }
    };

    socket.onclose = () => console.log("WebSocket CLOSED");
    socket.onerror = (e) => console.error("WebSocket ERROR", e);

    // Функція старту гри (глобальна)
    window.startGame = function() {
        if(!socket || socket.readyState !== WebSocket.OPEN) {
            console.log("WebSocket not open yet");
            return;
        }

        console.log("START GAME CLICK");
        socket.send(JSON.stringify({ type: "start_game" }));
    };

    window.onStartClick = function () {
        if (!playersInLobby || playersInLobby.length < 1) {
            alert("Недостатня кількість гравців для початку (мінімальна кількість 1)");
            return;
        }

        startGame();
        console.log("GAME STARTED");
    };

    window.kickPlayer = function (playerName) {
        if(!socket || socket.readyState !== WebSocket.OPEN) {
            console.log("WebSocket not open yet");
            return;
        }

        socket.send(JSON.stringify({
            type: "kick_player",
            player_name: playerName
        }));
    };
});
</script>
</body>
</html>
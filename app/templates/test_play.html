{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>–ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å</title>
    <link rel="icon" href="https://assets-cdn.kahoot.it/controller/v2/favicon.ico">
    <style>
        body {
            height: 100vh;
            background-image: url("{% static 'Home_bg.png' %}");
            background-size: cover;
            text-align: center;
            font-family: Arial, sans-serif;
            color: white;
        }

        button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 18px;
        }

        #waitingBox {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            background: black; /* —â–æ–± –Ω–µ –±—É–ª–æ –ø–æ—Ä–æ–∂–Ω—ñ—Ö –∫—Ä–∞—ó–≤ */
            z-index: 9999;
        }

        #waitingBox img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* üî• –ù–ï –∑–±—ñ–ª—å—à—É—î –≥—ñ—Ñ */
            display: block;
        }

        /* –¢–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö */
        .waiting-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;

            color: white;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;

            text-shadow: 0 0 10px black;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px 30px;
            border-radius: 12px;
        }

        #answerCounter {
            margin-top: 15px;
            font-size: 1.4rem;
            opacity: 0.9;
        }

    </style>
</head>

<body data-code="{{ session.code }}">

<h1>–í—ñ–∫—Ç–æ—Ä–∏–Ω–∞ —Ä–æ–∑–ø–æ—á–∞–ª–∞—Å—å</h1>
<p id="questionCounter"></p>

<div id="questionBox">
    <h2 id="questionText"></h2>

    <img id="questionImage" style="display:none; max-width:400px;">
    <video id="questionVideo" controls style="display:none; max-width:400px;"></video>
</div>

<div id="answersBox"></div>

<div id="waitingBox" style="display:none;">
    <img src="{% static 'waiting.gif' %}"/>
    
    <div class="waiting-text">
        –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ —ñ–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ –¥–∞–¥—É—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å...
        <div id="answerCounter">0 / 0</div>
    </div>
</div>


<div id="resultsBox" style="display:none;">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
    <table align="center">
        <thead>
            <tr>
                <th>–ì—Ä–∞–≤–µ—Ü—å</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
            </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const code = "{{ session.code }}";
    let storedName = localStorage.getItem("player_name");
    const playerName = (storedName && storedName !== "null") ? storedName : "";

    let redirected = false;  // üëà –§–õ–ê–ì

    const questionText = document.getElementById("questionText");
    const answersBox = document.getElementById("answersBox");
    const waitingBox = document.getElementById("waitingBox");
    const resultsBox = document.getElementById("resultsBox");
    const resultsTable = document.getElementById("resultsTable");

    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/game/" + code + "/?name=" + encodeURIComponent(playerName)
    );

    socket.onopen = () => {
        console.log("Socket opened on game page");
        // üëá –ó–ê–ü–†–û–°–ò –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°
        socket.send(JSON.stringify({
            type: "get_current_question"
        }));
    };

    socket.onmessage = (event) => {
        console.log("WebSocket connected");
        const data = JSON.parse(event.data);
        console.log(data);

        if (data.type === "question") {
             // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è
            const questionText = document.getElementById("questionText");
            questionText.innerText = data.text;

            // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
            const answersBox = document.getElementById("answersBox");
            answersBox.innerHTML = ""; // –æ—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∫–Ω–æ–ø–∫–∏

            data.options.forEach(answer => {
                const btn = document.createElement("button");
                btn.innerText = answer.text;

                // –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                btn.onclick = () => sendAnswer(answer.id);

                answersBox.appendChild(btn);
            });
        }

        if (data.type === "redirect") {
            if (!redirected) {  // üëà –ü–†–û–í–ï–†–Ø–ï–ú –§–õ–ê–ì
                redirected = true;
                window.location.href = data.url;
                return;  // üëà –í–´–•–û–î–ò–ú
            }
        }

        if (data.type === "waiting") {
            showWaiting();
        }

        if (data.type === "results") {
            showResults(data.results);
        }

        if (data.type === "answers_count") {
            document.getElementById("answerCounter").innerText =
                `${data.answered} / ${data.total}`;
        }
    };

    function sendAnswer(option_id) {
        if (socket.readyState !== WebSocket.OPEN) return;

        socket.send(JSON.stringify({
            type: "answer",
            option_id: option_id
        }));

        // —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫–∏
        document.getElementById("questionBox").style.display = "none";
        document.getElementById("answersBox").style.display = "none";

        // –ø–æ–∫–∞–∑—É—î–º–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
        document.getElementById("waitingBox").style.display = "block";
    }

    function showWaiting() {
        answersBox.innerHTML = "";
        waitingBox.style.display = "block";
    }

    function showResults(results) {
        waitingBox.style.display = "none";
        resultsBox.style.display = "block";
        resultsTable.innerHTML = "";

        results.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.name}</td><td>${r.correct}/${r.total}</td>`;
            resultsTable.appendChild(tr);
        });
    }
});
</script>
</body>
</html>

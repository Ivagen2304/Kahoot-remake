{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>–ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å</title>
    <link rel="icon" href="https://assets-cdn.kahoot.it/controller/v2/favicon.ico">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Nunito', Arial, sans-serif;
            overflow: hidden;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .question-section {
            text-align: center;
            margin-bottom: 40px;
            max-width: 800px;
            width: 100%;
        }

        #questionText {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s ease-in;
        }

        #timer {
            font-size: 4rem;
            font-weight: bold;
            color: #ff6b6b;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            animation: pulse 1s infinite;
        }

        .answers-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 800px;
            width: 100%;
            justify-items: stretch;
        }

        .answer-btn {
            width: 100%;
            padding: 30px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }

        .answer-btn:nth-child(1) {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .answer-btn:nth-child(2) {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .answer-btn:nth-child(3) {
            background: linear-gradient(135deg, #ffe66d, #ffb347);
        }

        .answer-btn:nth-child(4) {
            background: linear-gradient(135deg, #a8e6cf, #52c234);
        }

        .answer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }

        .answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #waitingBox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #waitingBox img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .waiting-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 30px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        #answerCounter {
            margin-top: 20px;
            font-size: 1.8rem;
            opacity: 0.9;
        }

        #resultsBox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .results-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .results-content h2 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
        }

        .results-table td {
            color: #555;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            #questionText {
                font-size: 2rem;
                padding: 20px;
            }

            .answers-section {
                grid-template-columns: 1fr;
            }

            .answer-btn {
                padding: 20px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body data-code="{{ session.code }}">
    <div class="game-container">
        <div class="question-section">
            <div id="questionText"></div>
            <div id="timer"></div>
        </div>

        <div class="answers-section" id="answersBox"></div>
    </div>

    <div id="waitingBox">
        <img src="{% static 'waiting.gif' %}" alt="Waiting animation" />
        <div class="waiting-text">
            –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ —ñ–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ –¥–∞–¥—É—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å...
            <div id="answerCounter">0 / 0</div>
        </div>
    </div>

    <div id="resultsBox">
        <div class="results-content">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>–ì—Ä–∞–≤–µ—Ü—å</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    </tr>
                </thead>
                <tbody id="resultsTable"></tbody>
            </table>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const code = "{{ session.code }}";
    let storedName = localStorage.getItem("player_name");
    const playerName = (storedName && storedName !== "null") ? storedName : "Player";

    let redirected = false;  // üëà –§–õ–ê–ì
    let timerInterval;  // –î–ª—è —Ç–∞–π–º–µ—Ä–∞
    let currentQuestionText = "";  // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞

    const questionText = document.getElementById("questionText");
    const answersBox = document.getElementById("answersBox");
    const waitingBox = document.getElementById("waitingBox");
    const resultsBox = document.getElementById("resultsBox");
    const resultsTable = document.getElementById("resultsTable");
    const timerDisplay = document.getElementById("timer");

    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/game/" + code + "/?name=" + encodeURIComponent(playerName)
    );

    socket.onopen = () => {
        console.log("Socket opened on game page");
        // üëá –ó–ê–ü–†–û–°–ò –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°
        socket.send(JSON.stringify({
            type: "get_current_question"
        }));
    };

    socket.onmessage = (event) => {
        console.log("WebSocket connected");
        const data = JSON.parse(event.data);
        console.log(data);

        if (data.type === "question") {
             // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è
            const questionText = document.getElementById("questionText");
            currentQuestionText = data.question;
            questionText.innerText = data.question;

            // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
            const answersBox = document.getElementById("answersBox");
            answersBox.innerHTML = ""; // –æ—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∫–Ω–æ–ø–∫–∏

            data.options.forEach((option, index) => {
                const btn = document.createElement("button");
                btn.innerText = option.text;
                btn.className = "answer-btn";

                // –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                btn.onclick = () => sendAnswer(option.id);

                answersBox.appendChild(btn);
            });

            // –ü–æ–∫–∞–∑–∞—Ç–∏ –±–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–Ω—è —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
            answersBox.style.display = "block";

            // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä
            if (data.time_limit) {
                startTimer(data.time_limit);
            }
        }

        if (data.type === "redirect") {
            if (!redirected) {  // üëà –ü–†–û–í–ï–†–Ø–ï–ú –§–õ–ê–ì
                redirected = true;
                window.location.href = data.url;
                return;  // üëà –í–´–•–û–î–ò–ú
            }
        }

        if (data.type === "waiting") {
            showWaiting();
        }

        if (data.type === "answer") {
            showAnswer(data.correct_option, data.wait_time);
        }

        if (data.type === "results") {
            showResults(data.results);
        }

        if (data.type === "answers_count") {
            document.getElementById("answerCounter").innerText =
                `${data.answered} / ${data.total}`;
        }

        if (data.type === "time_up") {
            // Time is up, show message but allow answering
            timerDisplay.innerText = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
        }
    };

    function sendAnswer(option_id) {
        if (socket.readyState !== WebSocket.OPEN) return;

        socket.send(JSON.stringify({
            type: "answer",
            option_id: option_id
        }));

        // —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫–∏
        document.getElementById("answersBox").style.display = "none";

        // –ø–æ–∫–∞–∑—É—î–º–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
        document.getElementById("waitingBox").style.display = "block";
    }

    function showWaiting() {
        answersBox.innerHTML = "";
        waitingBox.style.display = "block";
    }

    function showAnswer(correct_option, wait_time) {
        waitingBox.style.display = "none";
        questionText.innerText = `–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${correct_option}`;
        answersBox.innerHTML = "";

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º —á–µ—Ä–µ–∑ WebSocket –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç
    }

    function startTimer(timeLimit) {
        if (timerInterval) clearInterval(timerInterval);
        let timeLeft = timeLimit;
        timerDisplay.innerText = timeLeft;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDisplay.innerText = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
                // Allow answering even after time up
            }
        }, 1000);
    }

    function showResults(results) {
        if (timerInterval) clearInterval(timerInterval);
        waitingBox.style.display = "none";
        resultsBox.style.display = "flex";
        resultsTable.innerHTML = "";

        results.forEach(r => {
            const tr = document.createElement("tr");
            let nameCell = r.name;
            if (r.name === playerName) {
                nameCell = "(–í—ã) " + r.name;
            }
            tr.innerHTML = `<td>${nameCell}</td><td>${r.correct}/${r.total}</td>`;
            resultsTable.appendChild(tr);
        });
    }
});
</script>
</body>
</html>
